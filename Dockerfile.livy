FROM bitnami/spark:3.5

USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
      curl unzip ca-certificates tini \
      python3 \
 && rm -rf /var/lib/apt/lists/*

ENV LIVY_VERSION=0.8.0-incubating \
    LIVY_SCALA_VERSION=2.12 \
    LIVY_HOME=/opt/livy \
    SPARK_HOME=/opt/bitnami/spark \
    LIVY_LOG_DIR=/opt/livy/logs \
    LIVY_PID_DIR=/opt/livy/run \
    IVY_HOME=/opt/bitnami/.ivy2 \
    PYSPARK_PYTHON=/usr/bin/python3 \
    PYSPARK_DRIVER_PYTHON=/usr/bin/python3 \
    PATH=/opt/livy/bin:$PATH

# Download -> unzip -> move -> ensure perms
RUN set -eux; \
  url1="https://downloads.apache.org/incubator/livy/${LIVY_VERSION}/apache-livy-${LIVY_VERSION}_${LIVY_SCALA_VERSION}-bin.zip"; \
  url2="https://downloads.apache.org/incubator/livy/${LIVY_VERSION}/apache-livy-${LIVY_VERSION}-bin.zip"; \
  url3="https://archive.apache.org/dist/incubator/livy/${LIVY_VERSION}/apache-livy-${LIVY_VERSION}_${LIVY_SCALA_VERSION}-bin.zip"; \
  url4="https://archive.apache.org/dist/incubator/livy/${LIVY_VERSION}/apache-livy-${LIVY_VERSION}-bin.zip"; \
  curl -fSL "$url1" -o /tmp/livy.zip || \
  curl -fSL "$url2" -o /tmp/livy.zip || \
  curl -fSL "$url3" -o /tmp/livy.zip || \
  curl -fSL "$url4" -o /tmp/livy.zip; \
  unzip -q /tmp/livy.zip -d /opt; \
  LIVY_SRC_DIR="$(find /opt -maxdepth 1 -type d -name "apache-livy-${LIVY_VERSION}*")"; \
  mv "$LIVY_SRC_DIR" "${LIVY_HOME}"; \
  rm /tmp/livy.zip; \
  mkdir -p "${LIVY_LOG_DIR}" "${LIVY_PID_DIR}" "${LIVY_HOME}/conf"; \
  chmod +x ${LIVY_HOME}/bin/*; \
  test -f "${LIVY_HOME}/bin/livy-server"; \
  chown -R 1001:0 "${LIVY_HOME}"

# ---- Ivy cache: absolute, writable path + Spark default ----
RUN set -eux; \
  mkdir -p ${IVY_HOME}/cache ${IVY_HOME}/local ${SPARK_HOME}/conf; \
  chown -R 1001:0 ${IVY_HOME} ${SPARK_HOME}/conf; \
  echo "spark.jars.ivy ${IVY_HOME}" >> ${SPARK_HOME}/conf/spark-defaults.conf; \
  echo "spark.pyspark.python /usr/bin/python3" >> ${SPARK_HOME}/conf/spark-defaults.conf; \
  echo "spark.pyspark.driver.python /usr/bin/python3" >> ${SPARK_HOME}/conf/spark-defaults.conf

# Minimal config
COPY ./livy/livy.conf ${LIVY_HOME}/conf/livy.conf

EXPOSE 8998
USER 1001
ENTRYPOINT ["/usr/bin/tini","--"]
CMD ["bash","-lc","${LIVY_HOME}/bin/livy-server start \
  && (tail -F ${LIVY_LOG_DIR}/*.log ${LIVY_LOG_DIR}/*.out 2>/dev/null || sleep infinity)"]
